<!DOCTYPE html><html lang="en"><head><title>JS Dependency Management and YUI Loader Quirks</title><link rel="canonical" href="https://blog.davemo.com/posts/2009-03-13-javascript-dependency-management-and-yui-loader-quirks.html"><link rel="stylesheet" type="text/css" media="all" href="/css/app.css"><link rel="alternate" type="application/rss+xml" title="David Mosher | Canadian Software Developer, Designer, Musician, and Artist" href="/index.xml"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#00aba9"><meta name="theme-color" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" property="og:description" content="A solution for JavaScript dependency management using the YUI Loader."><meta name="theme-color" content="#bf5600"><meta name="author" content="David Mosher"><meta property="og:title" content="JS Dependency Management and YUI Loader Quirks"><meta name="date" content="2009-03-13"><meta name="article:published_time" content="2009-03-13"><meta name="article:modified_time" content="2009-03-13"><meta name="twitter:title" content="JS Dependency Management and YUI Loader Quirks"><meta name="twitter:image" content="https://blog.davemo.com/img/site/logo-social.png"><meta name="twitter:card" content="summary"><meta property="og:image" content="https://blog.davemo.com/img/site/logo-social.png"><meta name="twitter:site" content="@dmosher"><meta name="twitter:creator" content="@dmosher"><meta name="twitter:description" content="A solution for JavaScript dependency management using the YUI Loader."></head><body><div id="wrap"><div id="layout"><header><a href="/">blog.davemo.com</a><span class="description">thoughts on software, music, art, and meaning.</span></header><nav><a id="logo" href="/"></a><ul><li><a href="/archive.html">archive</a></li><li><a href="/">homepage</a></li><li><a href="/screencasts.html">screencasts</a></li><li><a href="/talks.html">talks</a></li></ul><div class="middle" id="older-newer"><div class="newer"><a href="/posts/2009-03-24-yui-uploader-and-ie7-flash-bugs.html">newer</a></div><div class="older"><a href="/posts/2008-12-17-application-usage-trends.html">older</a></div></div></nav><article id="post"><h1><a href="/posts/2009-03-13-javascript-dependency-management-and-yui-loader-quirks.html" title="Permanent link to ‘JS Dependency Management and YUI Loader Quirks’">JS Dependency Management and YUI Loader Quirks</a></h1><time datetime="2009-03-13">March 13th, 2009</time><aside class="tldr">
The YUI Loader can help you manage your JavaScript dependencies.
</aside>

<p><a href="https://bzabos.wordpress.com/">Brett</a> and I recently began refactoring a significant amount of the JavaScript that is currently in <a href="https://www.myfrontsteps.com">MyFrontSteps</a> and <a href="https://www.myfrontsteps.com/myfrontsteps/home/">Homebook</a>. One of the areas we identified as needing improvement was controlling when scripts get loaded in the page; it’s a challenging subject especially when utilizing Django templates which can extend and include bits of HTML that are both static and dynamic.</p>
<p>We’re not finished the refactoring quite yet but I thought it would be valuable to blog about the lessons we’ve learned early on about how to manage JavaScript loading without having script tags all over the place.</p>
<h2 id="manual-dependency-management-is-hard">Manual Dependency Management is Hard</h2>
<p>Not too long ago, Yahoo put out a list of <a href="https://developer.yahoo.com/performance/rules.html">guidelines</a> that web developers can use to enhance the performance of their websites. I won’t get into it in this post but there is a Firefox plugin called <a href="https://developer.yahoo.com/yslow/">YSlow</a> available that can automate some of the performance checking. The recommendation I’m going to focus on here is the one regarding moving scripts as close to the bottom of the page as possible.</p>
<p>I’ll just quote the <a href="https://developer.yahoo.com/performance/rules.html">Yahoo doc</a> as they explain it very clearly:</p>
<blockquote>
<p>The problem caused by scripts is that they block parallel downloads. The &gt; <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.4">HTTP/1.1 specification</a> suggests that browsers download no more than two components in parallel per hostname. If you serve your images from multiple hostnames, you can get more than two downloads to occur in parallel. While a script is downloading, however, the browser won’t start any other downloads, even on different hostnames. In some situations it’s not easy to move scripts to the bottom. If, for example, the script uses <code>document.write</code>to insert part of the page’s content, it can’t be moved lower in the page. There might also be scoping issues. In many cases, there are ways to workaround these situations.</p>
</blockquote>
<p>In the case of the code we’re using on MyFrontSteps we had all kinds of Django templates with includes and templatetags that include other little bits of dynamic JavaScript that was adding markup to the DOM and manipulating DOM content. Some of this code would appear prior to certain dependent scripts being loaded which created a real nightmare for us as we had to manually track down the position of the dependent scripts in the page that was fed to the browser after a variable number of layers of templates and includes.</p>
<p>We decided to research a better way to manage all these scripts and since we had been using the YUI library for many other parts of the website we settled on the <a href="https://developer.yahoo.com/yui/yuiloader/">YUI loader</a>.</p>
<h2 id="yui-loader-makes-dependency-management-easy">YUI Loader Makes Dependency Management Easy</h2>
<blockquote>
<p>The YUI Loader Utility is a client-side JavaScript component that allows you to load specific YUI components and their dependencies into your page via script. YUI Loader can operate as a holistic solution by loading all of your necessary YUI components, or it can be used to add one or more components to a page on which some YUI content already exists.</p>
</blockquote>
<p>The great thing about the YUI Loader is that you can use it to manage dependency sorting for all of the YUI components you use on a page but the <em>killer</em> feature
imho is the fact that it allows you to create custom modules to load your own JS and CSS libraries. The basic pattern we’re using in our root level Django template is as follows:</p>
<ol>
<li>Load all CSS Files at the top of the template</li>
<li>Place all YUI Loader and other statically included scripts at the bottom of
the page prior to the closing BODY tag</li>
<li>Define the YUI Loader instance</li>
<li>Define custom modules for the YUI loader</li>
<li>Provide a Django template block to allow manipulation of the onSuccess
callback</li>
<li>Call the YUI Loaders .insert() method to trigger insertion of all dependency
sorted scripts into the DOM</li>
</ol>
<p>The advantage to using the loader in conjunction with our root Django template is clear; all of our scripts are loaded at the bottom of the page and CSS is loaded at the top. When a user requests the pages they will start receiving the content from the server immediately and not have to wait for scripts to process as the loader dynamically inserts them into the HEAD element after the page content has been rendered.</p>
<p>Another trick we’re using to control when scripts get executed is by manipulating how the onSuccess callback of the loader works. Here’s the code:</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// Instantiate and configure YUI Loader:</span>
<span class="hljs-title class_">MFSLoader</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">YAHOO</span>.<span class="hljs-property">util</span>.<span class="hljs-title class_">YUILoader</span>({
    <span class="hljs-attr">base</span>: <span class="hljs-string">&quot;&quot;</span>,
    <span class="hljs-attr">require</span>: [<span class="hljs-string">&quot;base&quot;</span>,<span class="hljs-string">&quot;reset-fonts-grids&quot;</span>,<span class="hljs-string">&quot;MFS&quot;</span>],
    <span class="hljs-attr">loadOptional</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">combine</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">filter</span>: <span class="hljs-string">&quot;MIN&quot;</span>,
    <span class="hljs-attr">allowRollup</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">while</span>( <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span>.<span class="hljs-property">length</span> )  {
            <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span>.<span class="hljs-title function_">shift</span>()();
        }
    }
});
<span class="hljs-comment">// Define a list of executables that we</span>
<span class="hljs-comment">// can add to prior to page load completion</span>
<span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span> = [];
<span class="hljs-comment">// Custom Modules for Loader</span>
<span class="hljs-title class_">MFSLoader</span>.<span class="hljs-title function_">addModule</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;MFS&#x27;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;js&#x27;</span>, <span class="hljs-attr">varName</span>: <span class="hljs-string">&#x27;MFS&#x27;</span>,
    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;{% vurl &quot;/static/script/MFS.js&quot; %}&#x27;</span>,
    <span class="hljs-attr">requires</span>: [<span class="hljs-string">&#x27;jQuery&#x27;</span>, <span class="hljs-string">&#x27;jQueryUI&#x27;</span>]
});
{# <span class="hljs-title class_">Override</span> <span class="hljs-variable language_">this</span> block <span class="hljs-keyword">if</span> you need script at the <span class="hljs-variable language_">global</span> level. #}
{% block <span class="hljs-variable language_">global</span>.<span class="hljs-property">script</span> %}{% endblock %}
<span class="hljs-comment">// Trigger insertion of all dependency sorted scripts into the DOM</span>
<span class="hljs-title class_">MFSLoader</span>.<span class="hljs-title function_">insert</span>();
</code></pre>
<p>As you can see we have a few of the custom modules defined here, which include a <code>requires</code> attribute in the configuration object. This lets the YUI Loader know
that these files require the other modules to be loaded. The Loader then determines sort order for inclusion based on all required modules and goes to work inserting the scripts for you.</p>
<h2 id="tying-it-all-together">Tying it all Together</h2>
<p>The key to making this work in the varying levels of Django templates is to manipulate the <code>onSuccess</code> callback. When the YUI Loader finishes loading all the dependency sorted scripts it will execute this callback and allow you to then execute any additional code that depends on the dynamically inserted scripts. We have a number of namespaced JS objects for MyFrontSteps <code>MFS.js</code>, <code>MFS.DataGrid.js</code> etc.. and when we need to call functions defined in these objects we do so by extending the <code>global.script</code> block in our child template and pushing a new anonymous function onto the <code>MFSLoader.onReady</code> list we defined in the root template.</p>
<p>Here’s a simple example:</p>
<pre><code class="hljs language-javascript">{# A <span class="hljs-variable constant_">CHILD</span> <span class="hljs-variable constant_">TEMPLATE</span> #}
{% block <span class="hljs-variable language_">global</span>.<span class="hljs-property">script</span> %}
    #include the parent templates <span class="hljs-variable language_">global</span>.<span class="hljs-property">script</span> contents
    {{ block.<span class="hljs-property">super</span> }}
    <span class="hljs-comment">// Load our required features</span>
    <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-built_in">require</span>( <span class="hljs-string">&#x27;MFS.DataGrid&#x27;</span>, <span class="hljs-string">&#x27;uploader&#x27;</span>, <span class="hljs-string">&#x27;MFS.Uploader&#x27;</span> );
    <span class="hljs-comment">// Push an anonymous function onto the list</span>
    <span class="hljs-comment">// to get executed when all required scripts have been loaded</span>
    <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span>.<span class="hljs-title function_">push</span>( <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  {
        <span class="hljs-variable constant_">MFS</span>.<span class="hljs-property">DataGrid</span>.<span class="hljs-title function_">initPhotosGrid</span>();
    });
{% endblock %}
</code></pre>
<p>Once the page is rendered and the YUI Loader has finished parsing the loaded scripts the code we have in the onSuccess callback pops all the anonymous functions off the list which causes them to be executed.</p>
<pre><code class="hljs language-javascript">{# <span class="hljs-variable constant_">THE</span> <span class="hljs-variable constant_">ONSUCCESS</span> <span class="hljs-variable constant_">CALLBACK</span> #}
<span class="hljs-attr">onSuccess</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">while</span>( <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span>.<span class="hljs-property">length</span> )  {
        <span class="hljs-title class_">MFSLoader</span>.<span class="hljs-property">onReady</span>.<span class="hljs-title function_">shift</span>()();
    }
}
</code></pre>
<p>We still have a number of files to refactor, but the performance benefits we’ve seen so far using this approach have really made us confident that this is the way to go.</p>
<p>Using a dependency manager that works for custom JS / CSS libraries is just so much more liberating than having to manually keep track of where scripts are getting executed. Because we’re also migrating all of our code to external library files it makes things that much easier to debug in Firebug as well.</p>
</article><div id="sidebar"><div class="profile_image"><img src="/img/site/davemo.upscaled.png" alt="David A. Mosher"></div><div class="icons"><a class="icon github" href="https://github.com/davemo" title="davemo on github"></a><a class="icon linkedin" href="https://linkedin.com/in/dmosher" title="dmosher on linkedin"></a><a class="icon twitter" href="https://twitter.com/dmosher" title="dmosher on twitter"></a><a class="icon youtube" href="https://youtube.com/davidmosher" title="davidmosher on youtube"></a></div><p>David Mosher is a Canadian Software Developer, Designer, Musician, and Artist.</p></div><footer>&copy; 2007–2021 David Mosher</footer></div></div><script type="text/javascript" async src="/js/app.js"></script></body></html>